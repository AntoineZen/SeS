

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Lab 3: Valgrind &mdash; SeS 10.11.2015 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="SeS 10.11.2015 documentation" href="index.html"/>
        <link rel="next" title="Lab 5: Install last version of OpenSSH" href="lab5_notes.html"/>
        <link rel="prev" title="Lab 3: Kernel configuration" href="lab3_notes.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> SeS
          

          
          </a>

          
            
            
              <div class="version">
                0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="lab1_notes.html">Lab 1: Odoid Buildroot installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab2_uboot_notes.html">Lab 2: U-Boot</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab3_notes.html">Lab 3: Kernel configuration</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="">Lab 3: Valgrind</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#question-1-bitmap-c">Question 1: bitmap.c</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#memcheck">1) memcheck</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sgcheck">2) sgcheck</a></li>
<li class="toctree-l3"><a class="reference internal" href="#massif">3) massif</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="lab5_notes.html">Lab 5: Install last version of OpenSSH</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab6_filesystems_notes.html">Lab 6: File Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="annexes.html">Annexes</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">SeS</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>Lab 3: Valgrind</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/lab4_notes.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="lab-3-valgrind">
<h1>Lab 3: Valgrind<a class="headerlink" href="#lab-3-valgrind" title="Permalink to this headline">¶</a></h1>
<div class="section" id="question-1-bitmap-c">
<h2>Question 1: bitmap.c<a class="headerlink" href="#question-1-bitmap-c" title="Permalink to this headline">¶</a></h2>
<p>The goal of this question is to execice the following valgrind commands:</p>
<blockquote>
<div><ul class="simple">
<li>memcheck</li>
<li>sgcheck</li>
<li>massiv</li>
</ul>
</div></blockquote>
<p>We first need to compile the test program <code class="docutils literal"><span class="pre">bitmap.C</span></code></p>
<div class="highlight-python"><div class="highlight"><pre>$ gcc -Wall -g -o bitmap bitmap.C -lstdc++
</pre></div>
</div>
<p>the <strong>-Wall</strong> option turn on all warnings. The <strong>-g</strong> option enable to produce the debug symbol that will be processed by <em>valgrind</em>. The <strong>-o</strong> options enable to specify the output file name. the <strong>-lstd++</strong> specify to link the executable against C++ runtime library.</p>
<div class="section" id="memcheck">
<h3>1) memcheck<a class="headerlink" href="#memcheck" title="Permalink to this headline">¶</a></h3>
<p>Then we can run <em>valgrind</em> on the compliated program:</p>
<div class="highlight-python"><div class="highlight"><pre>$ valgrind --tool=memcheck ./bitmap
==7246== Memcheck, a memory error detector
==7246== Copyright (C) 2002-2013, and GNU GPL&#39;d, by Julian Seward et al.
==7246== Using Valgrind-3.10.0.SVN and LibVEX; rerun with -h for copyright info
==7246== Command: ./bitmap
==7246==
==7246== Invalid read of size 1
==7246==    at 0x400B2C: steganographyEncrypt(char const*, char const*, char const*) (bitmap.C:163)
==7246==    by 0x4007D4: main (bitmap.C:68)
==7246==  Address 0x5b1e26e is 2 bytes after a block of size 1,132 alloc&#39;d
==7246==    at 0x4C2B800: operator new[](unsigned long) (in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so)
==7246==    by 0x400A7A: steganographyEncrypt(char const*, char const*, char const*) (bitmap.C:137)
==7246==    by 0x4007D4: main (bitmap.C:68)
==7246==
==7246==
==7246== HEAP SUMMARY:
==7246==     in use at exit: 4,200 bytes in 1 blocks
==7246==   total heap usage: 536 allocs, 535 frees, 1,026,724 bytes allocated
==7246==
==7246== LEAK SUMMARY:
==7246==    definitely lost: 4,200 bytes in 1 blocks
==7246==    indirectly lost: 0 bytes in 0 blocks
==7246==      possibly lost: 0 bytes in 0 blocks
==7246==    still reachable: 0 bytes in 0 blocks
==7246==         suppressed: 0 bytes in 0 blocks
==7246== Rerun with --leak-check=full to see details of leaked memory
==7246==
==7246== For counts of detected and suppressed errors, rerun with: -v
==7246== ERROR SUMMARY: 240 errors from 1 contexts (suppressed: 0 from 0)
</pre></div>
</div>
<p>As <em>valgrind</em> recommend to re-run it with the <strong>&#8211;leak-check=full</strong> option, lets do it:</p>
<div class="highlight-python"><div class="highlight"><pre>$ valgrind --tool=memcheck  --leak-check=full ./bitmap
==7248== Memcheck, a memory error detector
==7248== Copyright (C) 2002-2013, and GNU GPL&#39;d, by Julian Seward et al.
==7248== Using Valgrind-3.10.0.SVN and LibVEX; rerun with -h for copyright info
==7248== Command: ./bitmap
==7248==
==7248== Invalid read of size 1
==7248==    at 0x400B2C: steganographyEncrypt(char const*, char const*, char const*) (bitmap.C:163)
==7248==    by 0x4007D4: main (bitmap.C:68)
==7248==  Address 0x5b1e26e is 2 bytes after a block of size 1,132 alloc&#39;d
==7248==    at 0x4C2B800: operator new[](unsigned long) (in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so)
==7248==    by 0x400A7A: steganographyEncrypt(char const*, char const*, char const*) (bitmap.C:137)
==7248==    by 0x4007D4: main (bitmap.C:68)
==7248==
==7248==
==7248== HEAP SUMMARY:
==7248==     in use at exit: 4,200 bytes in 1 blocks
==7248==   total heap usage: 536 allocs, 535 frees, 1,026,724 bytes allocated
==7248==
==7248== 4,200 bytes in 1 blocks are definitely lost in loss record 1 of 1
==7248==    at 0x4C2B800: operator new[](unsigned long) (in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so)
==7248==    by 0x4008EA: steganographyEncrypt(char const*, char const*, char const*) (bitmap.C:109)
==7248==    by 0x4007D4: main (bitmap.C:68)
==7248==
==7248== LEAK SUMMARY:
==7248==    definitely lost: 4,200 bytes in 1 blocks
==7248==    indirectly lost: 0 bytes in 0 blocks
==7248==      possibly lost: 0 bytes in 0 blocks
==7248==    still reachable: 0 bytes in 0 blocks
==7248==         suppressed: 0 bytes in 0 blocks
==7248==
==7248== For counts of detected and suppressed errors, rerun with: -v
==7248== ERROR SUMMARY: 241 errors from 2 contexts (suppressed: 0 from 0)
</pre></div>
</div>
<p>This reports two error:</p>
<blockquote>
<div><ul class="simple">
<li>An invalid read, it means an array has been exceeded at line 163.</li>
<li>A memory leak, from the memory allocated at line 109.</li>
</ul>
</div></blockquote>
<p>The loop surrounding line 163 is going one pixel to far. So we should correct the line 161 to:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="p">(</span><span class="n">widthLoop</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span> <span class="n">j</span><span class="o">=</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">hiddenText</span><span class="p">.</span><span class="n">p_rgb</span><span class="o">++</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>And the memory allocated at line 109 is not freed.  So we need to free it at the end of the functions.
For this, the following instrctuion was added after line 189:</p>
<div class="highlight-python"><div class="highlight"><pre>delete [] bitmap.p_buffer;
</pre></div>
</div>
<p>A <em>diff</em> of the file will show:</p>
<div class="highlight-python"><div class="highlight"><pre>$ diff -u bitmap.orig bitmap.C
--- bitmap.orig     2015-11-10 10:41:58.757686283 +0100
+++ bitmap.C        2015-11-10 11:10:05.617762542 +0100
@@ -158,7 +158,7 @@


         unsigned short j;
-        for (j=0; j&lt;(widthLoop+2); j=j+1, hiddenText.p_rgb++)
+        for (j=0; j&lt;(widthLoop+1); j=j+1, hiddenText.p_rgb++)
              {
                  if ((hiddenText.p_rgb-&gt;Blue != WHITE) ||
                      (hiddenText.p_rgb-&gt;Green!= WHITE) ||
@@ -187,6 +187,8 @@
    {
             delete [] *bitmap.p_row;
    }
+   delete [] bitmap.p_buffer;
+
    fclose(pFileSource);
    fclose(pFileDest);
 }
</pre></div>
</div>
<p>Now the same check shows no error:</p>
<div class="highlight-python"><div class="highlight"><pre>$ valgrind --tool=memcheck  --leak-check=full ./bitmap
==7478== Memcheck, a memory error detector
==7478== Copyright (C) 2002-2013, and GNU GPL&#39;d, by Julian Seward et al.
==7478== Using Valgrind-3.10.0.SVN and LibVEX; rerun with -h for copyright info
==7478== Command: ./bitmap
==7478==
==7478==
==7478== HEAP SUMMARY:
==7478==     in use at exit: 0 bytes in 0 blocks
==7478==   total heap usage: 536 allocs, 536 frees, 1,026,724 bytes allocated
==7478==
==7478== All heap blocks were freed -- no leaks are possible
==7478==
==7478== For counts of detected and suppressed errors, rerun with: -v
==7478== ERROR SUMMARY: 0 errors from 0 contexts (suppressed: 0 from 0)
</pre></div>
</div>
</div>
<div class="section" id="sgcheck">
<h3>2) sgcheck<a class="headerlink" href="#sgcheck" title="Permalink to this headline">¶</a></h3>
<p>The <em>sgcheck</em> show no error on the program:</p>
<div class="highlight-python"><div class="highlight"><pre>$ valgrind --tool=exp-sgcheck ./bitmap
==7485== exp-sgcheck, a stack and global array overrun detector
==7485== NOTE: This is an Experimental-Class Valgrind Tool
==7485== Copyright (C) 2003-2013, and GNU GPL&#39;d, by OpenWorks Ltd et al.
==7485== Using Valgrind-3.10.0.SVN and LibVEX; rerun with -h for copyright info
==7485== Command: ./bitmap
==7485==
--7485-- warning: evaluate_Dwarf3_Expr: unhandled DW_OP_ 0x93
--7485-- warning: evaluate_Dwarf3_Expr: unhandled DW_OP_ 0x93
--7485-- warning: evaluate_Dwarf3_Expr: unhandled DW_OP_ 0x93
--7485-- warning: evaluate_Dwarf3_Expr: unhandled DW_OP_ 0x93
--7485-- warning: evaluate_Dwarf3_Expr: unhandled DW_OP_ 0x93
--7485-- warning: evaluate_Dwarf3_Expr: unhandled DW_OP_ 0x93
--7485-- warning: evaluate_Dwarf3_Expr: unhandled DW_OP_ 0x93
--7485-- warning: evaluate_Dwarf3_Expr: unhandled DW_OP_ 0x93
--7485-- warning: evaluate_Dwarf3_Expr: unhandled DW_OP_ 0x93
--7485-- warning: evaluate_Dwarf3_Expr: unhandled DW_OP_ 0x93
--7485-- warning: evaluate_Dwarf3_Expr: unhandled DW_OP_ 0x93
--7485-- warning: evaluate_Dwarf3_Expr: unhandled DW_OP_ 0x93
--7485-- warning: evaluate_Dwarf3_Expr: unhandled DW_OP_ 0x93
--7485-- warning: evaluate_Dwarf3_Expr: unhandled DW_OP_ 0x93
--7485-- warning: evaluate_Dwarf3_Expr: unhandled DW_OP_ 0x93
--7485-- warning: evaluate_Dwarf3_Expr: unhandled DW_OP_ 0x93
==7485==
==7485== ERROR SUMMARY: 0 errors from 0 contexts (suppressed: 4 from 4)
</pre></div>
</div>
</div>
<div class="section" id="massif">
<h3>3) massif<a class="headerlink" href="#massif" title="Permalink to this headline">¶</a></h3>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="lab5_notes.html" class="btn btn-neutral float-right" title="Lab 5: Install last version of OpenSSH" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="lab3_notes.html" class="btn btn-neutral" title="Lab 3: Kernel configuration" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Antoine Zen-Ruffinen, , Yann Maret.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'10.11.2015',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>