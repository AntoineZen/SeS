

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Lab 5: Hardening Linux &mdash; SeS 10.11.2015 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="SeS 10.11.2015 documentation" href="index.html"/>
        <link rel="next" title="Lab 6: File Systems" href="lab6_filesystems_notes.html"/>
        <link rel="prev" title="Lab 3: Valgrind" href="lab4_notes.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> SeS
          

          
          </a>

          
            
            
              <div class="version">
                0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="lab1_notes.html">Lab 1: Odoid Buildroot installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab2_uboot_notes.html">Lab 2: U-Boot</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab3_notes.html">Lab 3: Kernel configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab4_notes.html">Lab 3: Valgrind</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="">Lab 5: Hardening Linux</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#question-1-check-the-signature-of-openssh-source-package">Question 1 : Check the signature of OpenSSH source package</a></li>
<li class="toctree-l2"><a class="reference internal" href="#question-2-configure-the-package">Question 2: Configure the package</a></li>
<li class="toctree-l2"><a class="reference internal" href="#question-3-configure-for-the-odroid">Question 3: Configure for the odroid</a></li>
<li class="toctree-l2"><a class="reference internal" href="#question-4-install-on-the-odroid">Question 4: Install on the Odroid</a></li>
<li class="toctree-l2"><a class="reference internal" href="#question-5-configure-ssh">Question 5: Configure ssh</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="lab6_filesystems_notes.html">Lab 6: File Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="annexes.html">Annexes</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">SeS</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>Lab 5: Hardening Linux</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/lab5_notes.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="lab-5-hardening-linux">
<h1>Lab 5: Hardening Linux<a class="headerlink" href="#lab-5-hardening-linux" title="Permalink to this headline">¶</a></h1>
<p>This lab is about installing the latest version of OpenSSH with the correct options to ensure maximum security. We also check that the source package is issued by the right developer to avoid installing untrusted software.</p>
<div class="section" id="question-1-check-the-signature-of-openssh-source-package">
<h2>Question 1 : Check the signature of OpenSSH source package<a class="headerlink" href="#question-1-check-the-signature-of-openssh-source-package" title="Permalink to this headline">¶</a></h2>
<p>The OpenSSH package can be downloaded from the project website or from a mirror. To download
the source package and its signature , we can use the following commands:</p>
<div class="highlight-python"><div class="highlight"><pre>$ wget http://mirror.switch.ch/ftp/pub/OpenBSD/OpenSSH/portable/openssh-7.1p1.tar.gz
$ wget http://mirror.switch.ch/ftp/pub/OpenBSD/OpenSSH/portable/openssh-7.1p1.tar.gz.asc
</pre></div>
</div>
<p>If we look into <code class="docutils literal"><span class="pre">openssh-7.1p1.tar.gz.asc</span></code> we see that it is a PGP signature.</p>
<p>Then we can check the downloaded archive:</p>
<div class="highlight-python"><div class="highlight"><pre>$ gpg --verify openssh-7.1p1.tar.gz.asc openssh-7.1p1.tar.gz
gpg: Signature made Fre 21 Aug 2015 07:10:03 CEST using RSA key ID 6D920D30
gpg: Can&#39;t check signature: public key not found
</pre></div>
</div>
<p>GPG complains that the public key is missing. GPG can download the key automaticaly from
the RSA public key ID:</p>
<div class="highlight-python"><div class="highlight"><pre>$ gpg --recv-keys 6D920D30
gpg: requesting key 6D920D30 from hkp server keys.gnupg.net
gpg: key 6D920D30: public key &quot;Damien Miller &lt;djm@mindrot.org&gt;&quot; imported
gpg: no ultimately trusted keys found
gpg: Total number processed: 1
gpg:               imported: 1  (RSA: 1)
</pre></div>
</div>
<p>We can retry the verification:</p>
<div class="highlight-python"><div class="highlight"><pre>$ gpg --verify openssh-7.1p1.tar.gz.asc openssh-7.1p1.tar.gz
gpg: Signature made Fre 21 Aug 2015 07:10:03 CEST using RSA key ID 6D920D30
gpg: Good signature from &quot;Damien Miller &lt;djm@mindrot.org&gt;&quot;
gpg: WARNING: This key is not certified with a trusted signature!
gpg:          There is no indication that the signature belongs to the owner.
Primary key fingerprint: 59C2 118E D206 D927 E667  EBE3 D3E5 F56B 6D92 0D30
</pre></div>
</div>
</div>
<div class="section" id="question-2-configure-the-package">
<h2>Question 2: Configure the package<a class="headerlink" href="#question-2-configure-the-package" title="Permalink to this headline">¶</a></h2>
<p>First we need to extract the source package:</p>
<div class="highlight-python"><div class="highlight"><pre>$ tar xzf openssh-7.1p1.tar.gz
$ cd openssh-7.1p1/
</pre></div>
</div>
<p>We need to make the <code class="docutils literal"><span class="pre">configure</span></code> script executable and then we can get the options list:</p>
<div class="highlight-python"><div class="highlight"><pre>$ chmod u+x configure
$ ./configure --help
`configure&#39; configures OpenSSH Portable to adapt to many kinds of systems.

Usage: ./configure [OPTION]... [VAR=VALUE]...

To assign environment variables (e.g., CC, CFLAGS...), specify them as
VAR=VALUE.  See below for descriptions of some of the useful variables.

Defaults for the options are specified in brackets.

Configuration:
  -h, --help              display this help and exit
      --help=short        display options specific to this package
      --help=recursive    display the short help of all the included packages
  -V, --version           display version information and exit
  -q, --quiet, --silent   do not print `checking...&#39; messages
      --cache-file=FILE   cache test results in FILE [disabled]
  -C, --config-cache      alias for `--cache-file=config.cache&#39;
  -n, --no-create         do not create output files
      --srcdir=DIR        find the sources in DIR [configure dir or `..&#39;]

Installation directories:
  --prefix=PREFIX         install architecture-independent files in PREFIX
                      [/usr/local]
  --exec-prefix=EPREFIX   install architecture-dependent files in EPREFIX
                      [PREFIX]

By default, `make install&#39; will install all the files in
`/usr/local/bin&#39;, `/usr/local/lib&#39; etc.  You can specify
an installation prefix other than `/usr/local&#39; using `--prefix&#39;,
for instance `--prefix=$HOME&#39;.

For better control, use the options below.

Fine tuning of the installation directories:
  --bindir=DIR           user executables [EPREFIX/bin]
  --sbindir=DIR          system admin executables [EPREFIX/sbin]
  --libexecdir=DIR       program executables [EPREFIX/libexec]
  --sysconfdir=DIR       read-only single-machine data [PREFIX/etc]
  --sharedstatedir=DIR   modifiable architecture-independent data [PREFIX/com]
  --localstatedir=DIR    modifiable single-machine data [PREFIX/var]
  --libdir=DIR           object code libraries [EPREFIX/lib]
  --includedir=DIR       C header files [PREFIX/include]
  --oldincludedir=DIR    C header files for non-gcc [/usr/include]
  --datarootdir=DIR      read-only arch.-independent data root [PREFIX/share]
  --datadir=DIR          read-only architecture-independent data [DATAROOTDIR]
  --infodir=DIR          info documentation [DATAROOTDIR/info]
  --localedir=DIR        locale-dependent data [DATAROOTDIR/locale]
  --mandir=DIR           man documentation [DATAROOTDIR/man]
  --docdir=DIR           documentation root [DATAROOTDIR/doc/openssh]
  --htmldir=DIR          html documentation [DOCDIR]
  --dvidir=DIR           dvi documentation [DOCDIR]
  --pdfdir=DIR           pdf documentation [DOCDIR]
  --psdir=DIR            ps documentation [DOCDIR]

System types:
  --build=BUILD     configure for building on BUILD [guessed]
  --host=HOST       cross-compile to build programs to run on HOST [BUILD]

Optional Features:
  --disable-FEATURE       do not include FEATURE (same as --enable-FEATURE=no)
  --enable-FEATURE[=ARG]  include FEATURE [ARG=yes]
  --disable-largefile     omit support for large files
  --disable-strip         Disable calling strip(1) on install
  --disable-etc-default-login Disable using PATH from /etc/default/login no
  --disable-lastlog       disable use of lastlog even if detected no
  --disable-utmp          disable use of utmp even if detected no
  --disable-utmpx         disable use of utmpx even if detected no
  --disable-wtmp          disable use of wtmp even if detected no
  --disable-wtmpx         disable use of wtmpx even if detected no
  --disable-libutil       disable use of libutil (login() etc.) no
  --disable-pututline     disable use of pututline() etc. (uwtmp) no
  --disable-pututxline    disable use of pututxline() etc. (uwtmpx) no

Optional Packages:
  --with-PACKAGE[=ARG]    use PACKAGE [ARG=yes]
  --without-PACKAGE       do not use PACKAGE (same as --with-PACKAGE=no)
  --without-openssl       Disable use of OpenSSL; use only limited internal crypto **EXPERIMENTAL**
  --without-ssh1          Enable support for SSH protocol 1
  --without-stackprotect  Don&#39;t use compiler&#39;s stack protection
  --without-hardening     Don&#39;t use toolchain hardening flags
  --without-rpath         Disable auto-added -R linker paths
  --with-cflags           Specify additional flags to pass to compiler
  --with-cppflags         Specify additional flags to pass to preprocessor
  --with-ldflags          Specify additional flags to pass to linker
  --with-libs             Specify additional libraries to link with
  --with-Werror           Build main code with -Werror
  --with-solaris-contracts Enable Solaris process contracts (experimental)
  --with-solaris-projects Enable Solaris projects (experimental)
  --with-osfsia           Enable Digital Unix SIA
  --with-zlib=PATH        Use zlib in PATH
  --without-zlib-version-check Disable zlib version check
  --with-skey[=PATH]      Enable S/Key support (optionally in PATH)
  --with-ldns[=PATH]      Use ldns for DNSSEC support (optionally in PATH)
  --with-libedit[=PATH]   Enable libedit support for sftp
  --with-audit=module     Enable audit support (modules=debug,bsm,linux)
  --with-pie              Build Position Independent Executables if possible
  --with-ssl-dir=PATH     Specify path to OpenSSL installation
  --without-openssl-header-check Disable OpenSSL version consistency check
  --with-ssl-engine       Enable OpenSSL (hardware) ENGINE support
  --with-prngd-port=PORT  read entropy from PRNGD/EGD TCP localhost:PORT
  --with-prngd-socket=FILE read entropy from PRNGD/EGD socket FILE (default=/var/run/egd-pool)
  --with-pam              Enable PAM support
  --with-privsep-user=user Specify non-privileged user for privilege separation
  --with-sandbox=style    Specify privilege separation sandbox (no, darwin, rlimit, systrace, seccomp_filter, capsicum)
  --with-selinux          Enable SELinux support
  --with-kerberos5=PATH   Enable Kerberos 5 support
  --with-privsep-path=xxx Path for privilege separation chroot (default=/var/empty)
  --with-xauth=PATH       Specify path to xauth program
  --with-maildir=/path/to/mail    Specify your system mail directory
  --with-mantype=man|cat|doc  Set man page type
  --with-md5-passwords    Enable use of MD5 passwords
  --without-shadow        Disable shadow password support
  --with-ipaddr-display   Use ip address instead of hostname in $DISPLAY
  --with-default-path=    Specify default $PATH environment for server
  --with-superuser-path=  Specify different path for super-user
  --with-4in6             Check for and convert IPv4 in IPv6 mapped addresses
  --with-bsd-auth         Enable BSD auth support
  --with-pid-dir=PATH     Specify location of ssh.pid file
  --with-lastlog=FILE|DIR specify lastlog location common locations

Some influential environment variables:
  CC          C compiler command
  CFLAGS      C compiler flags
  LDFLAGS     linker flags, e.g. -L&lt;lib dir&gt; if you have libraries in a
              nonstandard directory &lt;lib dir&gt;
  LIBS        libraries to pass to the linker, e.g. -l&lt;library&gt;
  CPPFLAGS    C/C++/Objective C preprocessor flags, e.g. -I&lt;include dir&gt; if
              you have headers in a nonstandard directory &lt;include dir&gt;
  CPP         C preprocessor

Use these variables to override the choices made by `configure&#39; or to help
it to find libraries and programs with nonstandard names/locations.

Report bugs to &lt;openssh-unix-dev@mindrot.org&gt;.
</pre></div>
</div>
<p>So for the lab, we need the following options:</p>
<blockquote>
<div><ul class="simple">
<li>&#8211;without-openssh</li>
<li>&#8211;without-ssh1</li>
<li>&#8211;with-pie</li>
<li>&#8211;prefix=`pwd`/install</li>
</ul>
</div></blockquote>
<p>We can now configure &amp; build the package:</p>
<div class="highlight-python"><div class="highlight"><pre>$ ./configure --without-openssl --without-ssh1 --with-pie --prefix=/home/antoine/master/Ses/lab5/ssh-install
$ make
$ sudo make install
</pre></div>
</div>
<p>We can see that the following was installed in <cite>/home/antoine/master/Ses/lab5/ssh-install`</cite>:</p>
<blockquote>
<div><img alt="_images/ssh_tree_1.png" src="_images/ssh_tree_1.png" />
</div></blockquote>
<p>We can delete this tree as we don&#8217;t need it. We will recompile it, but for the ARM processor.</p>
</div>
<div class="section" id="question-3-configure-for-the-odroid">
<h2>Question 3: Configure for the odroid<a class="headerlink" href="#question-3-configure-for-the-odroid" title="Permalink to this headline">¶</a></h2>
<p>We try now to cross-compile for the odroid. We need to specify the gcc compiler to use by specifying the host prefix. Before this, we need to put the cross-compiler on the PATH, so that the <code class="docutils literal"><span class="pre">configure</span></code> script is able to find it:</p>
<div class="highlight-python"><div class="highlight"><pre>$ export PATH=/home/antoine/workspace/xu3/buildroot/output/host/usr/bin:$PATH
$ ./configure --without-openssl --without-ssh1 --with-pie --prefix=/home/antoine/master/Ses/lab5/ssh-install --host=arm-linux-gnueabihf

$ make
$ make install
</pre></div>
</div>
<p>The last step (<code class="docutils literal"><span class="pre">make</span> <span class="pre">install</span></code>) will fail as it don&#8217;t use the right strip utility. To correct this, we need to edit the <code class="docutils literal"><span class="pre">Makefile</span></code> to tell it to use the right utility, as we need the ARM version of it. So we need to change line 35 in the <code class="docutils literal"><span class="pre">Makefile</span></code></p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">STRIP_OPT</span><span class="o">=-</span><span class="n">s</span> <span class="o">--</span><span class="n">strip</span><span class="o">-</span><span class="n">program</span><span class="o">=</span><span class="n">arm</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnueabihf</span><span class="o">-</span><span class="n">strip</span>
</pre></div>
</div>
<p>We can then redo the install</p>
<div class="highlight-python"><div class="highlight"><pre>$ make install
</pre></div>
</div>
<p>Despite the error, we have the same tree installed:</p>
<blockquote>
<div><img alt="_images/ssh_tree_2.png" src="_images/ssh_tree_2.png" />
</div></blockquote>
<p>We can see that we have an executable for the ARM machine:</p>
<div class="highlight-python"><div class="highlight"><pre>antoine@antoine-vb-64:~/master/Ses/lab5/ssh-install$ file sbin/sshd
sbin/sshd: ELF 32-bit LSB  shared object, ARM, EABI5 version 1 (SYSV), dynamically linked (uses shared libs), for GNU/Linux 3.1.1, BuildID[sha1]=a220decacaf8a2d54a8c26802898a631964103b4, stripped
</pre></div>
</div>
</div>
<div class="section" id="question-4-install-on-the-odroid">
<h2>Question 4: Install on the Odroid<a class="headerlink" href="#question-4-install-on-the-odroid" title="Permalink to this headline">¶</a></h2>
<p>We can copy the installation to the root fs:</p>
<div class="highlight-python"><div class="highlight"><pre>$ sudo cp -r * /media/antoine/rootfs/
</pre></div>
</div>
</div>
<div class="section" id="question-5-configure-ssh">
<h2>Question 5: Configure ssh<a class="headerlink" href="#question-5-configure-ssh" title="Permalink to this headline">¶</a></h2>
<p>We need to add the following options to <code class="docutils literal"><span class="pre">/etc/sshd_config</span></code></p>
<div class="highlight-python"><div class="highlight"><pre># Force use of IPv4 only
Port 22
ListenAddress 0.0.0.0

# Force use of protocol version 2
Protocol 2

# Disable port forwarding
AllowTcpForwarding no

# Select the allowed cyphers
Ciphers aes256-cbc, aes256-ctr, aes128-cbc, blowfish-cbc, 3des-cbc, hmac-sha256, hmac-sha1

# Enable privilege separation
UsePrivilegeSeparation yes

# Don&#39;t allow root to login
PermitRootLogin no

# Give a banner file
Banner /etc/sshd_banner
</pre></div>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="lab6_filesystems_notes.html" class="btn btn-neutral float-right" title="Lab 6: File Systems" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="lab4_notes.html" class="btn btn-neutral" title="Lab 3: Valgrind" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Antoine Zen-Ruffinen, , Yann Maret.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'10.11.2015',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>