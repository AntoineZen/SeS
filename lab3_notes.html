

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Lab 3: Kernel configuration &mdash; SeS 10.11.2015 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="SeS 10.11.2015 documentation" href="index.html"/>
        <link rel="next" title="Lab 3: Valgrind" href="lab4_notes.html"/>
        <link rel="prev" title="Lab 2: U-Boot" href="lab2_uboot_notes.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> SeS
          

          
          </a>

          
            
            
              <div class="version">
                0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="lab1_notes.html">Lab 1: Odoid Buildroot installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab2_uboot_notes.html">Lab 2: U-Boot</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="">Lab 3: Kernel configuration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#question-1-configure-a-secure-kernel">Question 1: Configure a secure kernel</a></li>
<li class="toctree-l2"><a class="reference internal" href="#question-2-check-the-syn-coockies">Question 2: Check the syn-coockies</a></li>
<li class="toctree-l2"><a class="reference internal" href="#question-3-activate-the-wifi">Question 3: Activate the WiFi</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#find-the-approrpiate-linux-diver">1) Find the approrpiate Linux diver</a></li>
<li class="toctree-l3"><a class="reference internal" href="#activate-this-drive-to-the-kernel">2) Activate this drive to the kernel</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configure-the-wifi-authentication-wpa-supplicant">4) Configure the WiFi authentication (wpa_supplicant)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configure-the-wireless-network-ip-part">5)Configure the wireless network (IP part)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="lab4_notes.html">Lab 3: Valgrind</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab5_notes.html">Lab 5: Install last version of OpenSSH</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab6_filesystems_notes.html">Lab 6: File Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="annexes.html">Annexes</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">SeS</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>Lab 3: Kernel configuration</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/lab3_notes.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="lab-3-kernel-configuration">
<h1>Lab 3: Kernel configuration<a class="headerlink" href="#lab-3-kernel-configuration" title="Permalink to this headline">¶</a></h1>
<div class="section" id="question-1-configure-a-secure-kernel">
<h2>Question 1: Configure a secure kernel<a class="headerlink" href="#question-1-configure-a-secure-kernel" title="Permalink to this headline">¶</a></h2>
<p>The goal here is to have a running Linux kernel with the following options:</p>
<blockquote>
<div><ul class="simple">
<li>Enabled random generator</li>
<li>Enabled TCP Syn Cookie protection</li>
<li>Randomize_va-Space option</li>
<li>Write protected kernel text sections</li>
<li>Filtered access to /dev/mem</li>
<li>Strip assembler-generated symbols</li>
<li>Enable &#8211;fstack-protector option</li>
<li>Restrict unprivileged access to kernel (dmesg)</li>
<li>Enable SELinux</li>
<li>Disable IPv6</li>
</ul>
</div></blockquote>
<p>To obtain the menu to configure the kernel, first navigate to the buildroot root, then run the command from the Makefile:</p>
<div class="highlight-python"><div class="highlight"><pre>$ cd ~/workspace/xu3/buildroot
$ make linux-xconfig
</pre></div>
</div>
<p>after the right options have been disabled, just type:</p>
<div class="highlight-python"><div class="highlight"><pre>$ make
</pre></div>
</div>
<p>Once the compilation is ended, copy the fresh kernel to the eMMC-Card:</p>
<div class="highlight-python"><div class="highlight"><pre>$ sudo cp ~/workspace/xu3/buildroot/output/images/uImage /media/&lt;users&gt;/bootfs/
</pre></div>
</div>
<p>The uSD-Card can then be inserted into the Odroid and the system can be booted. After the boot, we can verify that we are running the fresh kernel using the <code class="docutils literal"><span class="pre">uname</span></code> command:</p>
<div class="highlight-python"><div class="highlight"><pre>$ uname -a
Linux odroidxu3 3.10.63 #1 SMP PREEMPT Tue Oct 27 08:55:42 CET 2015 armv7l GNU/Linux
</pre></div>
</div>
<p>The date &amp; time in the command output should match with kernel compilation time.</p>
</div>
<div class="section" id="question-2-check-the-syn-coockies">
<h2>Question 2: Check the syn-coockies<a class="headerlink" href="#question-2-check-the-syn-coockies" title="Permalink to this headline">¶</a></h2>
<p>The goal here is to check that the new kernel is proof to &#8216;syn-cookie&#8217; attack. It is possible to disable the syn-cookie attack protection at run time using the following command:</p>
<div class="highlight-python"><div class="highlight"><pre># sysctl -w net.ipv4.tcp_syncookies=0
$ net.ipv4.tcp_syncookies = 0
</pre></div>
</div>
<p>We can monitor what append with netstat:</p>
<div class="highlight-python"><div class="highlight"><pre>$ watch -n2 netstat -atn
</pre></div>
</div>
<p>the <em>-a</em> options tels netstat that we want to show established connection and non-established connections. The <em>-t</em> options tell that we want to see TCP connections. The <em>-n</em> options tells that we want to see the addresses in numerical format. The <em>watch -n2</em> enable to update the netstat command every two seconds.</p>
<p>On the host machine, we need to temporary change the IP address to be in the same net as
the Odroid. This can be archived using the following command:</p>
<div class="highlight-python"><div class="highlight"><pre>$ sudo ifconfig eth0 192.168.0.12 netmask 255.255.255.0 up
</pre></div>
</div>
<p>We can check that this is effective using a <em>&#8220;ping&#8221;</em> command</p>
<div class="highlight-python"><div class="highlight"><pre>$ ping 192.168.1.11
</pre></div>
</div>
<p>The IP address was configured in the previous Lab, using &#8220;/etc/network/interfaces&#8221;.</p>
<p>To make the attack, open scapy in root mode:</p>
<div class="highlight-python"><div class="highlight"><pre>$ sudo scapy
</pre></div>
</div>
<p>This open an IPython shell with the current name-space populated with Scapy objects. This is convenient to build attacks. First we need to define our syn-cookies packet:</p>
<div class="highlight-python"><div class="highlight"><pre>In [1]: p = IP(dst=&#39;192.168.0.11&#39;, id=1111, ttl=99)/TCP(sport=RandShort(), dport=22, seq=12345, ack=1000, window=1000, flags=&#39;S&#39;)/&#39;HaX0r SVP&#39;
</pre></div>
</div>
<p>Also we need to block the TCP reset that will be placed by the Host Linux when he receive the SYN/ACK from the Odroid:</p>
<div class="highlight-python"><div class="highlight"><pre>$ sudo iptables -A OUTPUT -p tcp -s 192.168.0.12 --tcp-flags RST RST -j DROP
</pre></div>
</div>
</div>
<div class="section" id="question-3-activate-the-wifi">
<h2>Question 3: Activate the WiFi<a class="headerlink" href="#question-3-activate-the-wifi" title="Permalink to this headline">¶</a></h2>
<div class="section" id="find-the-approrpiate-linux-diver">
<h3>1) Find the approrpiate Linux diver<a class="headerlink" href="#find-the-approrpiate-linux-diver" title="Permalink to this headline">¶</a></h3>
<p>To find which driver we need to add to the buildroot image, we simply plug the USB network adapter
into the host PC and observes the kernel logs:</p>
<div class="highlight-python"><div class="highlight"><pre>$ dmsg
....
[ 5646.374861] rtl8192cu: MAC address: 74:da:38:02:44:e1
[ 5646.374868] rtl8192cu: Board Type 0
[ 5646.377664] rtl_usb: rx_max_size 15360, rx_urb_num 8, in_ep 1
[ 5646.377722] rtl8192cu: Loading firmware rtlwifi/rtl8192cufw_TMSC.bin
[ 5646.378175] usbcore: registered new interface driver rtl8192cu
[ 5646.396422] ieee80211 phy0: Selected rate control algorithm &#39;rtl_rc&#39;
[ 5646.398272] rtlwifi: wireless switch is on
[ 5646.425397] rtl8192cu: MAC auto ON okay!
[ 5646.964307] rtl8192cu: Tx queue select: 0x05
[ 5648.229120] IPv6: ADDRCONF(NETDEV_UP): wlan0: link is not ready
</pre></div>
</div>
<p>So it appears that 3 kernel modules are involved here:</p>
<blockquote>
<div><ul class="simple">
<li>rtl8192cu</li>
<li>rtl_usb</li>
<li>rtlwifi</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="activate-this-drive-to-the-kernel">
<h3>2) Activate this drive to the kernel<a class="headerlink" href="#activate-this-drive-to-the-kernel" title="Permalink to this headline">¶</a></h3>
<p>The drivers are located here:</p>
<div class="highlight-python"><div class="highlight"><pre>$ antoine@antoine-vb-64:~/workspace/xu3/buildroot/output/build/linux-eiafr-5/drivers$ find . -name *rtl8192cu*
./net/wireless/rtl8192cu_v40
./net/wireless/rtl8192cu_v40/hal/rtl8192c/usb/rtl8192cu_xmit.o
./net/wireless/rtl8192cu_v40/hal/rtl8192c/usb/rtl8192cu_recv.o
./net/wireless/rtl8192cu_v40/hal/rtl8192c/usb/.rtl8192cu_recv.o.cmd
./net/wireless/rtl8192cu_v40/hal/rtl8192c/usb/.rtl8192cu_xmit.o.cmd
./net/wireless/rtl8192cu_v40/hal/rtl8192c/usb/rtl8192cu_recv.c
./net/wireless/rtl8192cu_v40/hal/rtl8192c/usb/rtl8192cu_xmit.c
./net/wireless/rtl8192cu_v40/hal/rtl8192c/usb/.rtl8192cu_led.o.cmd
./net/wireless/rtl8192cu_v40/hal/rtl8192c/usb/rtl8192cu_led.o
./net/wireless/rtl8192cu_v40/hal/rtl8192c/usb/rtl8192cu_led.c
./net/wireless/rtlwifi/rtl8192cu
</pre></div>
</div>
<p>in <code class="docutils literal"><span class="pre">~/workspace/xu3/buildroot/output/build/linux-eiafr-5/drivers/net/wireless/Kconfig</span></code> uncomment line 284:</p>
<div class="highlight-python"><div class="highlight"><pre>source &quot;drivers/net/wireless/rtlwifi/Kconfig&quot;
</pre></div>
</div>
<p>in <code class="docutils literal"><span class="pre">~/workspace/xu3/buildroot/output/build/linux-eiafr-5/drivers/net/wireless/Makefile</span></code>, uncomment line 27:</p>
<div class="highlight-python"><div class="highlight"><pre>obj-$(CONFIG_RTLWIFI)       += rtlwifi/
</pre></div>
</div>
<p>Then we need to reconfigure the kernel build system to build the module driver:</p>
<div class="highlight-python"><div class="highlight"><pre>$ cd ~/workspace/xu3/buildroot
$ make linux-xconfig
</pre></div>
</div>
<p>Enable it in &#8220;Drivers / Network device support / Wireless LAN&#8221; option &#8220;Realtek 8192C USB WiFi&#8221;</p>
<p>Type <em>&#8220;make&#8221;</em> to build the image</p>
<p>We need to copy the new kernel and RootFS to the uSDCard. For this we have a new install script that place only the kernel and RootFS. The file is &#8220;4_copy_kernel_rootfs.hs&#8221;</p>
<p>Then we do on the Odroid the command to activate the kernel module driver:</p>
<div class="highlight-python"><div class="highlight"><pre>$ modprobe rtl8192cu
</pre></div>
</div>
<p>It will complain that the firmware file is missing. Just copy all rtwifi firmware from the host PC to the uSD card:</p>
<div class="highlight-python"><div class="highlight"><pre>$ sudo cp -r /lib/firmware/rtlwifi /media/antoine/e3409f1a-2196-4d11-97c8-36c81d0fd6af/lib/firmware/
</pre></div>
</div>
<p>We can then install The kernel module:</p>
<div class="highlight-python"><div class="highlight"><pre>$ insmod rtl8192cu
</pre></div>
</div>
</div>
<div class="section" id="configure-the-wifi-authentication-wpa-supplicant">
<h3>4) Configure the WiFi authentication (wpa_supplicant)<a class="headerlink" href="#configure-the-wifi-authentication-wpa-supplicant" title="Permalink to this headline">¶</a></h3>
<p>The WiFi authentication and security is manage by the <em>wpa_supplicant</em> deamon. It need the <code class="docutils literal"><span class="pre">/etc/wpa.supplicant.conf</span></code> config file:</p>
<div class="highlight-python"><div class="highlight"><pre>ctrl_interface=/var/run/wpa_supplicant
ap_scan=1

network={
  key_mgmt=WPA-PSK
  ssid=&quot;SeS&quot;
  scan_ssid=1
  proto=RSN
  pairwise=CCMP
  group=CCMP
  psk=&quot;A*/1deGr&quot;
}
</pre></div>
</div>
</div>
<div class="section" id="configure-the-wireless-network-ip-part">
<h3>5)Configure the wireless network (IP part)<a class="headerlink" href="#configure-the-wireless-network-ip-part" title="Permalink to this headline">¶</a></h3>
<p>We need to add the configuration option for the new network interface to  <code class="docutils literal"><span class="pre">/etc/network/interfaces</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre>auto wlan0
pre-up wpa_supplicatn -B -iwlan0
</pre></div>
</div>
<p>Then we need to restart the network using:</p>
<div class="highlight-python"><div class="highlight"><pre>$ /etc/init.d/S40network restart
</pre></div>
</div>
<p>It complain that the interface might already be used:</p>
<div class="highlight-python"><div class="highlight"><pre>Successfully initialized wpa_supplicant
ctrl_iface exists and seems to be in use - cannot override it
Delete &#39;/var/run/wpa_supplicant/wlan0&#39; manually if it is not used anymore
Failed to initialize control interface &#39;/var/run/wpa_supplicant&#39;.
You may have another wpa_supplicant process already running or the file was
left by an unclean termination of wpa_supplicant in which case you will need
to manually remove this file before starting wpa_supplicant again.
</pre></div>
</div>
<p>So we need to delete the file mentioned:</p>
<div class="highlight-python"><div class="highlight"><pre>$ rm /var/run/wpa_supplicant/wlan0
</pre></div>
</div>
<p>We can restart the network again:</p>
<div class="highlight-python"><div class="highlight"><pre>$ /etc/init.d/S40network restart
</pre></div>
</div>
<p>And this time, we get an IP address !:</p>
<div class="highlight-python"><div class="highlight"><pre>Stopping network...[  754.271642] [c4] smsc95xx 1-1.1:1.0 eth0: hardware isn&#39;t capable of remote wakeup
ifdown: interface wlan0 not configured
Starting network...
[  754.372258] [c4] smsc95xx 1-1.1:1.0 eth0: hardware isn&#39;t capable of remote wakeup
Successfully initialized wpa_supplicant
udhcpc (v1.22.1) started
Sending discover...
[  757.430149] [c0] wlan0: deauthenticating from 20:aa:4b:c5:17:35 by local choice (reason=2)
[  757.456276] [c0] cfg80211: Calling CRDA to update world regulatory domain
[  757.463107] [c0] wlan0: authenticate with 20:aa:4b:c5:17:35
[  757.480052] [c0] wlan0: send auth to 20:aa:4b:c5:17:35 (try 1/3)
[  757.487129] [c0] wlan0: authenticated
[  757.493669] [c2] wlan0: associate with 20:aa:4b:c5:17:35 (try 1/3)
[  757.503521] [c0] wlan0: RX AssocResp from 20:aa:4b:c5:17:35 (capab=0x431 status=0 aid=1)
[  757.510210] [c0] rtlwifi:addbareq_rx():&lt;100-1&gt; sta is NULL
[  757.516130] [c0] wlan0: associated
Sending discover...
Sending select for 192.168.1.105...
Sending select for 192.168.1.105...
Sending select for 192.168.1.105...
Lease of 192.168.1.105 obtained, lease time 86400
deleting routers
adding dns 192.168.1.1
</pre></div>
</div>
<p>Success !</p>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="lab4_notes.html" class="btn btn-neutral float-right" title="Lab 3: Valgrind" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="lab2_uboot_notes.html" class="btn btn-neutral" title="Lab 2: U-Boot" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Antoine Zen-Ruffinen, , Yann Maret.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'10.11.2015',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>